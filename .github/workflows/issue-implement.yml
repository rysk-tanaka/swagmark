name: Issue Implement

on:
  issues:
    types: [labeled]

concurrency:
  group: issue-implement-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  implement:
    if: github.event.label.name == 'claude-implement'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Check for existing implementation PR
        id: guard
        uses: actions/github-script@v8
        with:
          script: |
            const issueNumber = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const pullRequests = await github.paginate(
              github.rest.pulls.list,
              {
                owner,
                repo,
                state: "open",
                per_page: 100,
              }
            );

            const closesPattern = new RegExp(
              `Closes\\s+\`?#${issueNumber}\`?\\b`,
              "i"
            );

            const existingPr = pullRequests.find((pr) =>
              closesPattern.test(pr.body ?? "")
            );

            if (existingPr) {
              core.info(
                `Existing PR found for issue #${issueNumber}: #${existingPr.number}`
              );
              core.setOutput("skip", "true");
              core.setOutput("existing_pr_number", String(existingPr.number));
              return;
            }

            core.setOutput("skip", "false");

      - name: Skip when implementation PR already exists
        if: steps.guard.outputs.skip == 'true'
        run: |
          echo "Existing PR: #${{ steps.guard.outputs.existing_pr_number }}"

      - name: Enable pnpm via corepack
        if: steps.guard.outputs.skip != 'true'
        run: corepack enable pnpm

      - name: Setup Node.js
        if: steps.guard.outputs.skip != 'true'
        uses: actions/setup-node@v6
        with:
          node-version: 24
          cache: pnpm

      - name: Install dependencies
        if: steps.guard.outputs.skip != 'true'
        run: pnpm install --frozen-lockfile

      - name: Implement issue with Claude
        if: steps.guard.outputs.skip != 'true'
        uses: anthropics/claude-code-action@beta
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: '--max-turns 25 --model claude-sonnet-4-6 --allowed-tools "Read,Edit,Write,Glob,Grep,Bash(git *),Bash(gh issue view *),Bash(gh pr create *),Bash(gh pr edit *),Bash(pnpm *)"'
          prompt: |
            Issue #${{ github.event.issue.number }} を実装し、PR を作成してください。

            手順:
            1. `gh issue view ${{ github.event.issue.number }}` で Issue の要件を確認する
            2. `git checkout -b implement-issue-${{ github.event.issue.number }}` で作業ブランチを作成する（既存ならそのブランチを使う）
            3. 実装を行う
            4. `pnpm test` を実行して品質を確認する
            5. `pnpm format` を実行して整形する
            6. 変更をコミットしてプッシュする
            7. `gh pr create` で PR を作成し、本文に必ず `Closes #${{ github.event.issue.number }}` を含める
            8. `gh pr edit --add-label claude-review` で PR に `claude-review` ラベルを付与する

            要件:
            - 既存のコーディング規約に従う
            - コミットメッセージは英語で Conventional Commits 形式にする
            - PR には変更内容とテスト結果を簡潔に記載する

      - name: Notify failure to issue
        if: failure() && steps.guard.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          message=$(
            cat <<EOF
          自動実装に失敗しました。以下のワークフロー実行ログを確認してください。

          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF
          )
          gh issue comment "${{ github.event.issue.number }}" --body "$message"
