name: Auto Fix CI

on:
  workflow_run:
    workflows: ["Test"]
    types: [completed]

jobs:
  auto-fix:
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.pull_requests[0] &&
      github.event.workflow_run.head_repository.full_name == github.repository
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 1

      - name: Check for previous auto-fix attempt
        id: guard
        run: |
          AUTHOR_EMAIL=$(git log -1 --format='%ae')
          if [[ "$AUTHOR_EMAIL" == "41898282+github-actions[bot]@users.noreply.github.com" ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup git identity
        if: steps.guard.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        if: steps.guard.outputs.skip != 'true'
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Install dependencies
        if: steps.guard.outputs.skip != 'true'
        run: |
          corepack enable pnpm
          pnpm install --frozen-lockfile || pnpm install

      - name: Get CI failure details
        if: steps.guard.outputs.skip != 'true'
        id: failure
        uses: actions/github-script@v7
        env:
          RUN_ID: ${{ github.event.workflow_run.id }}
        with:
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: process.env.RUN_ID * 1
            });
            const failedJobs = jobs.data.jobs.filter(j => j.conclusion === 'failure');
            const MAX_LOG_CHARS = 10000;
            let errorLogs = [];
            for (const job of failedJobs) {
              const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                job_id: job.id
              });
              // @octokit/rest follows the 302 redirect and returns plain text in data
              const fullLog = logs.data;
              const truncated = fullLog.length > MAX_LOG_CHARS
                ? '...(truncated)\n' + fullLog.slice(-MAX_LOG_CHARS)
                : fullLog;
              errorLogs.push({ jobName: job.name, logs: truncated });
            }
            return {
              failedJobs: failedJobs.map(j => j.name),
              errorLogs
            };

      - name: Fix CI failures with Claude
        if: steps.guard.outputs.skip != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: '--model claude-sonnet-4-6 --allowed-tools "Edit,Write,Read,Glob,Grep,Bash(git *),Bash(pnpm *),Bash(gh pr comment *),Bash(gh pr view *)"'
          prompt: |
            CI ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’åˆ†æã—ã¦ä¿®æ­£ã—ã€ã“ã®ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚

            PR: #${{ github.event.workflow_run.pull_requests[0].number }}
            ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.event.workflow_run.head_branch }}
            å¤±æ•—ã‚¸ãƒ§ãƒ–: ${{ join(fromJSON(steps.failure.outputs.result).failedJobs, ', ') }}

            ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°:
            ${{ toJSON(fromJSON(steps.failure.outputs.result).errorLogs) }}

            æ‰‹é †:
            1. ã‚¨ãƒ©ãƒ¼ã®åŸå› ã‚’ç‰¹å®šã™ã‚‹
            2. `gh pr view` ã§ PR ã®å†…å®¹ã‚’ç¢ºèªã—ã€å¤‰æ›´ã®æ–‡è„ˆã‚’æŠŠæ¡ã™ã‚‹
            3. ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã™ã‚‹ï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ›´æ–°ãŒå¿…è¦ãªå ´åˆã¯ `pnpm test -- -u` ã‚’å®Ÿè¡Œï¼‰
            4. `pnpm test` ã§ä¿®æ­£ã‚’æ¤œè¨¼ã™ã‚‹
            5. å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¦ `git push origin HEAD:refs/heads/${{ github.event.workflow_run.head_branch }}` ã§ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹

            ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è‹±èªã§ Conventional Commits å½¢å¼ã«ã—ã¦ãã ã•ã„ã€‚
            ä¿®æ­£å†…å®¹ã‚’ PR ã«ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚

            ---
            ğŸ¤– ãƒ¢ãƒ‡ãƒ«: [å®Ÿéš›ã®ãƒ¢ãƒ‡ãƒ«å] / ğŸ’° ã‚³ã‚¹ãƒˆ: å…¥åŠ›[N]ãƒˆãƒ¼ã‚¯ãƒ³, å‡ºåŠ›[M]ãƒˆãƒ¼ã‚¯ãƒ³, $[é‡‘é¡]
